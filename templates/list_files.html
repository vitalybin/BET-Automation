<!DOCTYPE html>
<html>
<head>
  <title>Uploaded BET Files</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background:#f7f8fa }
    .card { border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,.06) }
    .file-badge { font-size:.8rem }
    .table thead th { white-space: nowrap; }
    .table td { vertical-align: middle; }
    .btn-icon { display:inline-flex;align-items:center;gap:.35rem; }
    .status-pill {
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:.8rem;
      border-radius:999px;
      padding:.15rem .6rem;
    }
    /* small, subtle panel under the actions row */
    .template-panel {
      border-top: 1px dashed rgba(0,0,0,.12);
      margin-top: .25rem;
      padding-top: .25rem;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h1 class="mb-0">üìö Uploaded BET Files</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-primary" href="/">Upload new</a>
      <a class="btn btn-outline-secondary" href="/api">API</a>
    </div>
  </div>
  <p class="text-muted mb-4">
    Excel and PDF uploads. The <strong>View</strong> button always opens the correct page:
    Excel ‚Üí Excel view, PDF ‚Üí PDF view.<br>
    You can optionally choose an ELN <strong>Template</strong> and title before clicking
    <strong>Send to ELN</strong>.
  </p>

  <div class="card p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:60px">ID</th>
            <th>File</th>
            <th style="width:90px">Type</th>
            <th style="width:140px">Date</th>
            <th style="width:100px">Time</th>
            <th style="width:320px">Actions</th>
            <th style="width:200px">ELN Status</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr id="row-{{ it.id }}">
            <td class="text-muted">{{ it.id }}</td>
            <td>
              <div class="fw-semibold">{{ it.file_name }}</div>
              <div class="small text-muted">#{{ it.id }}</div>
            </td>
            <td>
              {% if it.type == 'PDF' %}
                <span class="badge bg-warning text-dark file-badge">PDF</span>
              {% else %}
                <span class="badge bg-info text-dark file-badge">Excel</span>
              {% endif %}
            </td>
            <td>{{ it.date or '‚Äî' }}</td>
            <td>{{ it.time or '‚Äî' }}</td>
            <td>
              <div class="d-flex flex-column gap-1">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <!-- View -->
                  <a class="btn btn-sm btn-outline-primary btn-icon" href="{{ it.view_url }}">View</a>

                  <!-- Metadata -->
                  <a class="btn btn-sm btn-outline-secondary btn-icon" href="{{ it.metadata_url }}">Metadata</a>

                  <!-- ELN push form (template + title + send) -->
                  <form
                    onsubmit="return pushELN(event, {{ it.id }})"
                    class="d-flex flex-wrap gap-1 align-items-center eln-form">

                    <!-- Toggle template panel -->
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-dark btn-icon template-toggle"
                      title="Show available ELN templates">
                      <span>Template</span>
                    </button>

                    <!-- Send to ELN -->
                    <button class="btn btn-sm btn-success btn-icon" type="submit">
                      <span>Send to ELN</span>
                    </button>

                    <!-- Panel that opens when 'Template' is clicked -->
                    <div class="w-100 template-panel d-none">
                      <div class="d-flex flex-wrap gap-2 align-items-center mt-1">
                        <div class="d-flex flex-column">
                          <label class="small mb-0 text-muted">Template</label>
                          <select
                            name="template_id"
                            class="form-select form-select-sm template-select"
                            style="min-width: 140px; max-width: 180px;"
                            title="Select an ELN template">
                            <option value="">No template (default)</option>
                            <!-- JS will populate options -->
                          </select>
                        </div>

                        <div class="d-flex flex-column">
                          <label class="small mb-0 text-muted">Title</label>
                          <input
                            type="text"
                            name="title"
                            class="form-control form-control-sm"
                            style="min-width: 160px; max-width: 260px;"
                            value="File {{ it.id }}"
                            title="Experiment title in ELN">
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </td>
            <td>
              <span id="eln-status-{{ it.id }}" class="status-pill bg-light text-muted">
                <span>‚óè</span><span>Not pushed</span>
              </span>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7" class="text-center py-4 text-muted">
              <em>No files yet. Upload one to get started.</em>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="p-3 d-flex justify-content-between flex-wrap gap-2">
      <div class="small text-muted">{{ items|length }} total</div>
      <div class="text-muted small">Showing latest first</div>
    </div>
  </div>
</div>

<script>
/* ---------- ELN status pill helpers ---------- */
function setStatus(fileId, state, message) {
  const el = document.getElementById('eln-status-' + fileId);
  if (!el) return;
  const spans = el.querySelectorAll('span');
  const dotSpan  = spans[0];
  const textSpan = spans[1];

  el.classList.remove('bg-light','text-muted','bg-warning','text-dark',
                      'bg-success','text-white','bg-danger');

  if (state === 'idle') {
    el.classList.add('bg-light','text-muted');
    dotSpan.textContent = '‚óè';
    textSpan.textContent = message || 'Not pushed';
  } else if (state === 'pushing') {
    el.classList.add('bg-warning','text-dark');
    dotSpan.textContent = '‚óè';
    textSpan.textContent = message || 'Pushing‚Ä¶';
  } else if (state === 'ok') {
    el.classList.add('bg-success','text-white');
    dotSpan.textContent = '‚úî';
    textSpan.textContent = message || 'Pushed OK';
  } else if (state === 'error') {
    el.classList.add('bg-danger','text-white');
    dotSpan.textContent = '‚úñ';
    textSpan.textContent = message || 'Failed';
  }
}

/* ---------- Template loading and panel toggle ---------- */
document.addEventListener('DOMContentLoaded', function () {
  let templatesCache = null;
  let templatesLoaded = false;

  async function fetchTemplates() {
    if (templatesCache) return templatesCache;
    try {
      const resp = await fetch('/api/elab/templates');
      if (!resp.ok) {
        console.error('Failed to load templates', resp.status);
        return [];
      }
      templatesCache = await resp.json();
      return templatesCache;
    } catch (err) {
      console.error('Template fetch error', err);
      return [];
    }
  }

  async function ensureTemplatesLoaded() {
    if (templatesLoaded) return;
    const templates = await fetchTemplates();
    const selects = document.querySelectorAll('.template-select');

    selects.forEach(select => {
      // keep first "No template" option, clear others
      while (select.options.length > 1) {
        select.remove(1);
      }
      templates.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.title || ('Template ' + t.id);
        select.appendChild(opt);
      });
    });

    templatesLoaded = true;
  }

  document.querySelectorAll('.template-toggle').forEach(btn => {
    btn.addEventListener('click', async function () {
      const form = btn.closest('form');
      const panel = form.querySelector('.template-panel');
      if (!panel) return;

      await ensureTemplatesLoaded();

      panel.classList.toggle('d-none');
    });
  });
});

/* ---------- ELN push (existing flow, now with template_id + title) ---------- */
async function pushELN(ev, fileId) {
  ev.preventDefault();
  const form = ev.target;
  const btn  = form.querySelector('button[type="submit"]');
  const fd   = new FormData(form);
  const origHtml = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = 'Pushing‚Ä¶';
  setStatus(fileId, 'pushing', 'Pushing to ELN‚Ä¶');

  try {
    const r = await fetch(`/eln/${fileId}`, {
      method: 'POST',
      body: fd,
      headers: { 'Accept': 'application/json' }
    });

    let data;
    try {
      data = await r.json();
    } catch (e) {
      setStatus(fileId, 'error', 'Invalid JSON from server');
      alert('ELN push failed: invalid JSON from server');
      return false;
    }

    if (!r.ok || !data.ok) {
      const msg = (data && data.error) ? data.error : r.statusText;
      setStatus(fileId, 'error', msg);
      alert('ELN push failed: ' + msg);
    } else {
      const msg = 'OK (ID ' + data.exp_id + ')';
      setStatus(fileId, 'ok', msg);
      alert('ELN created ‚úÖ  Experiment ID: ' + data.exp_id);
    }
  } catch (e) {
    console.error('pushELN error', e);
    setStatus(fileId, 'error', 'Network/JSON error');
    alert('Network/JSON error: ' + e);
  } finally {
    btn.disabled = false;
    btn.innerHTML = origHtml;
  }
  return false;
}
</script>
</body>
</html>
