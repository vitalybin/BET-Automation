<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BET PDF View ‚Äì {{ pdf_filename }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background:#f7f8fa; }
    .card { border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.06); }
    .section-title {
      font-size: .9rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 600;
      color:#6c757d;
      margin-bottom:.5rem;
    }
    .pill-badge {
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      font-size:.8rem;
      border-radius:999px;
      padding:.15rem .7rem;
      background:#fef3c7;
      color:#92400e;
    }
    .pill-badge span.dot {
      width:.5rem;
      height:.5rem;
      border-radius:999px;
      background:#f59e0b;
      display:inline-block;
    }
    .table-sm td, .table-sm th {
      padding:.3rem .5rem;
      font-size:.8rem;
    }
    .meta-grid dt {
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#6c757d;
    }
    .meta-grid dd {
      margin-bottom:.75rem;
      font-weight:500;
    }
  </style>
</head>
<body>
<div class="container py-4 py-md-5">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">üìÑ BET PDF Measurement ‚Äì {{ pdf_filename }}</h1>
      <p class="text-muted mb-0">
        View of the extracted metadata and BET data points from the uploaded PDF report,
        together with an interactive plot.
      </p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="/files" class="btn btn-outline-secondary btn-sm">‚Üê Back to list</a>
      <a href="{{ metadata_url }}" class="btn btn-outline-primary btn-sm">
        Download Metadata (Excel)
      </a>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left column: clean meta + compact summary -->
    <div class="col-lg-5">
      <!-- Measurement meta -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="section-title">Measurement Meta Data</div>
              <h2 class="h5 mb-0">
                {{ file_info.comment5 or file_info.comment1 or pdf_filename }}
              </h2>
            </div>
            <div class="pill-badge">
              <span class="dot"></span>
              <span>PDF</span>
            </div>
          </div>

          <dl class="row meta-grid mb-0">
            <dt class="col-5">Sample date</dt>
            <dd class="col-7">
              {{ file_info.date_of_measurement or '‚Äî' }}
              {% if file_info.time_of_measurement %} {{ file_info.time_of_measurement }}{% endif %}
            </dd>

            <dt class="col-5">Operator</dt>
            <dd class="col-7">
              {{ file_info.comment2 or '‚Äî' }}
            </dd>

            <dt class="col-5">Instrument</dt>
            <dd class="col-7">
              {{ file_info.comment4 or '‚Äî' }}
            </dd>

            <dt class="col-5">Serial #</dt>
            <dd class="col-7">
              {{ file_info.serial_number or '‚Äî' }}
            </dd>

            <dt class="col-5">Version</dt>
            <dd class="col-7">
              {{ file_info.version or '‚Äî' }}
            </dd>

            <dt class="col-5">Conditions</dt>
            <dd class="col-7">
              {{ file_info.comment3 or '‚Äî' }}
            </dd>
          </dl>
        </div>
      </div>

      <!-- Compact extracted summary (only BET / t-plot) -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="section-title">Extracted Summary (BET / t-Plot)</div>
          {% if bundle.summaries %}
            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Section</th>
                    <th scope="col">Field</th>
                    <th scope="col">Value</th>
                  </tr>
                </thead>
                <tbody>
                {% for s in bundle.summaries %}
                  {% set parts = s.key.split(':', 1) %}
                  <tr>
                    <td class="text-nowrap">
                      {{ parts[0].replace('_', ' ') }}
                    </td>
                    <td class="text-nowrap">
                      {{ parts[1] if parts|length > 1 else '' }}
                    </td>
                    <td>{{ s.value }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0"><em>No BET/t-Plot summary fields extracted.</em></p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right column: Plot + raw data -->
    <div class="col-lg-7">
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="section-title">BET Plot</div>
              <h2 class="h5 mb-0">p/po vs p/va (BET transform)</h2>
            </div>
          </div>

          {% if pts_data and pts_data|length > 1 %}
            <canvas id="betChartPdf" style="max-height:420px;"></canvas>
          {% else %}
            <p class="text-muted mb-0"><em>No valid BET points available to plot.</em></p>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="section-title">Raw Extracted BET Data</div>
              <h2 class="h6 mb-0">
                {{ pts_data|length if pts_data else 0 }} points
              </h2>
            </div>
          </div>

          {% if pts_data and pts_data|length > 0 %}
            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">p/p0</th>
                    <th scope="col">p/va_p0_p</th>
                  </tr>
                </thead>
                <tbody>
                {% for p in pts_data %}
                  <tr>
                    <td>{{ p.no }}</td>
                    <td>
                      {% if p.p_p0 is not none %}
                        {{ "%.5f"|format(p.p_p0) }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                    <td>
                      {% if p.p_va_p0_p is not none %}
                        {{ "%.5f"|format(p.p_va_p0_p) }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0"><em>No BET data points stored for this PDF.</em></p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const ptsData = {{ pts_data|tojson }};
  if (!ptsData || ptsData.length < 2) return;

  const xVals = ptsData.map(p => p.p_p0);
  const yVals = ptsData.map(p => p.p_va_p0_p);

  const ctx = document.getElementById('betChartPdf');
  if (!ctx) return;

  const data = {
    labels: xVals,
    datasets: [
      {
        label: 'BET data (p/po vs p/va_p0_p)',
        data: yVals,
        pointRadius: 4,
        pointHoverRadius: 6,
        tension: 0.1
      }
    ]
  };

  const config = {
    type: 'line',
    data: data,
    options: {
      responsive: true,
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const x = ctx.label;
              const y = ctx.parsed.y;
              return `p/po=${x}, p/va_p0_p=${y}`;
            }
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'p/p0' } },
        y: { title: { display: true, text: 'p/va_p0_p' } }
      }
    }
  };

  new Chart(ctx, config);
})();
</script>

</body>
</html>
