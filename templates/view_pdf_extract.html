<!DOCTYPE html>
<html>
<head>
  <title>PDF BET Extract</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background:#f7f8fa; }
    .card { border-radius:14px; box-shadow:0 4px 18px rgba(0,0,0,.05); }
    .status-pill {
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:.8rem;
      border-radius:999px;
      padding:.15rem .6rem;
    }
    .chart-wrapper{
      position:relative;
      width:100%;
      max-width:900px;
      margin:0 auto;
      height:380px;
    }
    #betChart{
      width:100% !important;
      height:100% !important;
    }
    .table-meta th{
      width:40%;
      font-weight:600;
    }
    .badge-region{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .table-points thead th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="container py-4 py-md-5">

  <!-- Header row -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="fs-3">üìÑ</span>
      <div>
        <h1 class="h4 mb-1 mb-md-0">PDF BET Extract</h1>
        <div class="text-muted small">
          File ID #{{ bundle.file_id }} ‚Äì
          <span class="badge bg-dark-subtle text-dark badge-region">
            {{ sample_region }}
          </span>
        </div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="/files" class="btn btn-outline-secondary btn-sm">‚Üê Back to files</a>
      <a href="{{ metadata_url }}" class="btn btn-outline-primary btn-sm">
        Download metadata Excel
      </a>
    </div>
  </div>

  <!-- Measurement header + ELN push -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-md-7">
          <h2 class="h5 mb-2">{{ header.measurement_id }}</h2>
          <div class="small text-muted mb-1">
            <strong>Date:</strong>
            {% if header.date %}{{ header.date }}{% else %}‚Äî{% endif %}
            {% if header.time %} {{ header.time }}{% endif %}
          </div>
          <div class="small text-muted mb-1">
            <strong>Operator:</strong> {{ header.operator or "‚Äî" }}
          </div>
          <div class="small text-muted mb-1">
            <strong>Instrument:</strong> {{ header.instrument or "‚Äî" }}
          </div>
          <div class="small text-muted">
            <strong>Serial #:</strong> {{ header.serial_number or "‚Äî" }}
            &nbsp;&nbsp;|&nbsp;&nbsp;
            <strong>Version:</strong> {{ header.version or "‚Äî" }}
          </div>
          <div class="small text-muted mt-1">
            <strong>Points in DB:</strong> {{ bundle.points_count }}
          </div>
        </div>

        <div class="col-md-5">
          <div class="d-flex flex-column flex-sm-row justify-content-sm-end gap-2">
            <!-- ELN status pill -->
            <span id="eln-status-{{ bundle.file_id }}"
                  class="status-pill bg-light text-muted">
              <span>‚óè</span><span>Not pushed from this view</span>
            </span>

            <!-- ELN push form with range -->
            <form class="d-flex flex-wrap gap-2 align-items-center"
                  onsubmit="return pushELN(event, {{ bundle.file_id }})">
              <input type="number"
                     name="template_id"
                     class="form-control form-control-sm"
                     style="max-width:90px"
                     placeholder="Template"
                     title="Optional ELN template ID (for tagging only)">
              <input type="hidden" name="title"
                     value="{{ header.measurement_id or ('File ' ~ bundle.file_id) }}">
              <!-- range that gets sent to ELN -->
              <input type="hidden" id="eln_plot_xmin" name="plot_xmin">
              <input type="hidden" id="eln_plot_xmax" name="plot_xmax">

              <button type="submit" class="btn btn-success btn-sm">
                Send to ELN
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Plot + Range controls + BET points table -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
          <h2 class="h5 mb-1">BET Plot (p/p‚ÇÄ vs p/va_p‚ÇÄ-p)</h2>
          <div class="text-muted small">
            Grey line: complete extracted BET data.<br>
            Colored line: central region (core BET range approximation) ‚Äì original instrument
            selection may differ.
          </div>
        </div>
        <div class="small text-muted">
          P/Po range: {% if default_x_min is not none %}{{ default_x_min }}{% else %}‚Äî{% endif %}
          to {% if default_x_max is not none %}{{ default_x_max }}{% else %}‚Äî{% endif %}
        </div>
      </div>

      <div class="chart-wrapper mb-3">
        <canvas id="betChart"></canvas>
      </div>

      <!-- Range UI (this controls chart + what is sent to ELN) -->
      <form class="row g-2 align-items-end mb-3">
        <div class="col-6 col-md-3">
          <label class="form-label form-label-sm">p/p‚ÇÄ min</label>
          <input type="number" step="0.0001" class="form-control form-control-sm"
                 id="range_xmin"
                 value="{% if default_x_min is not none %}{{ default_x_min }}{% endif %}">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label form-label-sm">p/p‚ÇÄ max</label>
          <input type="number" step="0.0001" class="form-control form-control-sm"
                 id="range_xmax"
                 value="{% if default_x_max is not none %}{{ default_x_max }}{% endif %}">
        </div>
        <div class="col-md-3">
          <button type="button" class="btn btn-outline-primary btn-sm w-100"
                  onclick="applyRange()">
            Apply range to plot
          </button>
        </div>
      </form>

      <!-- BET points table -->
      <h3 class="h6 mb-2">BET data points (from DB)</h3>
      <p class="text-muted small">
        First all points as imported from the isotherm CSV (p/p‚ÇÄ vs p/va_p‚ÇÄ-p).
      </p>
      {% if pts_data and pts_data|length > 0 %}
      <div class="table-responsive" style="max-height:260px;overflow:auto;">
        <table class="table table-sm table-hover align-middle table-points mb-0">
          <thead>
          <tr>
            <th class="text-muted">#</th>
            <th class="text-muted">p/p‚ÇÄ</th>
            <th class="text-muted">p/va_p‚ÇÄ-p</th>
          </tr>
          </thead>
          <tbody>
          {% for p in pts_data %}
            <tr>
              <td>{{ p.no }}</td>
              <td>
                {% if p.p_p0 is not none %}
                  {{ "%.6f"|format(p.p_p0) }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>
                {% if p.p_va_p0_p is not none %}
                  {{ "%.6f"|format(p.p_va_p0_p) }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted mb-0"><em>No BET points available for this file.</em></p>
      {% endif %}

    </div>
  </div>

  <!-- Core metadata & non-core -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Core metadata</h2>
          <p class="text-muted small">
            Key BET / t-plot values considered important (surface area, pore volume, etc.).
          </p>

          {% if core_fields and core_fields|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm table-borderless table-meta mb-0">
              <tbody>
              {% for row in core_fields %}
                <tr>
                  <th class="text-muted">{{ row.key }}</th>
                  <td>{{ row.value }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0"><em>No core fields detected for this file.</em></p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Non-core metadata -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Additional extracted fields</h2>
          <p class="text-muted small">
            Remaining fields from the PDF report (marked as non-core).
          </p>

          {% if extra_fields and extra_fields|length > 0 %}
          <div class="table-responsive" style="max-height:260px;overflow:auto;">
            <table class="table table-sm table-borderless table-meta mb-0">
              <tbody>
              {% for row in extra_fields %}
                <tr>
                  <th class="text-muted">{{ row.key }}</th>
                  <td>{{ row.value }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0"><em>No additional fields stored.</em></p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // -------------------------------
  // Status pill helpers
  // -------------------------------
  function setStatus(fileId, state, message) {
    const el = document.getElementById('eln-status-' + fileId);
    if (!el) return;
    const dotSpan  = el.querySelector('span:first-child');
    const textSpan = el.querySelector('span:last-child');

    el.classList.remove('bg-light','text-muted','bg-warning','text-dark',
                        'bg-success','text-white','bg-danger');

    if (state === 'idle') {
      el.classList.add('bg-light','text-muted');
      dotSpan.textContent = '‚óè';
      textSpan.textContent = message || 'Not pushed';
    } else if (state === 'pushing') {
      el.classList.add('bg-warning','text-dark');
      dotSpan.textContent = '‚óè';
      textSpan.textContent = message || 'Pushing‚Ä¶';
    } else if (state === 'ok') {
      el.classList.add('bg-success','text-white');
      dotSpan.textContent = '‚úî';
      textSpan.textContent = message || 'Pushed OK';
    } else if (state === 'error') {
      el.classList.add('bg-danger','text-white');
      dotSpan.textContent = '‚úñ';
      textSpan.textContent = message || 'Failed';
    }
  }

  async function pushELN(ev, fileId) {
    ev.preventDefault();
    const form = ev.target;
    const btn  = form.querySelector('button[type="submit"]');
    const fd   = new FormData(form);
    const origHtml = btn.innerHTML;

    // copy current range into hidden inputs (for backend plot range)
    const xminInput = document.getElementById('range_xmin');
    const xmaxInput = document.getElementById('range_xmax');
    const elnXmin   = document.getElementById('eln_plot_xmin');
    const elnXmax   = document.getElementById('eln_plot_xmax');
    if (elnXmin && xminInput) elnXmin.value = xminInput.value || '';
    if (elnXmax && xmaxInput) elnXmax.value = xmaxInput.value || '';

    btn.disabled = true;
    btn.innerHTML = 'Pushing‚Ä¶';
    setStatus(fileId, 'pushing', 'Pushing to ELN‚Ä¶');

    try {
      const r = await fetch(`/eln/${fileId}`, {
        method: 'POST',
        body: fd,
        headers: { 'Accept': 'application/json' }
      });

      let data;
      try {
        data = await r.json();
      } catch (e) {
        setStatus(fileId, 'error', 'Invalid JSON from server');
        alert('ELN push failed: invalid JSON from server');
        return false;
      }

      if (!r.ok || !data.ok) {
        const msg = (data && data.error) ? data.error : r.statusText;
        setStatus(fileId, 'error', msg);
        alert('ELN push failed: ' + msg);
      } else {
        const msg = 'OK (ID ' + data.exp_id + ')';
        setStatus(fileId, 'ok', msg);
        alert('ELN created ‚úÖ  Experiment ID: ' + data.exp_id);
      }
    } catch (e) {
      console.error('pushELN error', e);
      setStatus(fileId, 'error', 'Network/JSON error');
      alert('Network/JSON error: ' + e);
    } finally {
      btn.disabled = false;
      btn.innerHTML = origHtml;
    }
    return false;
  }

  // -------------------------------
  // Chart.js plot with core segment
  // -------------------------------
  const ptsData = {{ pts_data|tojson|safe }};
  let allPoints = ptsData
    .filter(p => p.p_p0 !== null && p.p_p0 !== undefined &&
                 p.p_va_p0_p !== null && p.p_va_p0_p !== undefined)
    .map(p => ({ x: p.p_p0, y: p.p_va_p0_p }))
    .sort((a,b) => a.x - b.x);

  const defaultXmin = {{ default_x_min if default_x_min is not none else 'null' }};
  const defaultXmax = {{ default_x_max if default_x_max is not none else 'null' }};

  const ctx = document.getElementById('betChart').getContext('2d');

  function splitCoreSegment(points, xmin, xmax) {
    if (!points.length) return { full: [], core: [] };

    // Filter by range if provided
    let inRange = points;
    if (typeof xmin === 'number') inRange = inRange.filter(p => p.x >= xmin);
    if (typeof xmax === 'number') inRange = inRange.filter(p => p.x <= xmax);

    if (inRange.length < 3) {
      return { full: points, core: [] };
    }

    // Take central 40% as "core" region visually
    const n = inRange.length;
    const start = Math.floor(n * 0.3);
    const end   = Math.ceil(n * 0.7);
    const core  = inRange.slice(start, end);

    return { full: points, core: core };
  }

  let currentXmin = defaultXmin;
  let currentXmax = defaultXmax;

  const segments = splitCoreSegment(allPoints, currentXmin, currentXmax);

  const betChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Full BET data',
          data: segments.full,
          showLine: true,
          pointRadius: 2,
          borderWidth: 1,
          borderColor: 'rgba(140,140,140,0.9)',
          backgroundColor: 'rgba(140,140,140,0.9)',
          cubicInterpolationMode: 'monotone'
        },
        {
          label: 'Core region (visual)',
          data: segments.core,
          showLine: true,
          pointRadius: 2,
          borderWidth: 2,
          borderColor: 'rgba(33,150,243,1)',
          backgroundColor: 'rgba(33,150,243,1)',
          cubicInterpolationMode: 'monotone'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: { boxWidth: 12, usePointStyle: true }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const x = ctx.parsed.x;
              const y = ctx.parsed.y;
              return `p/p‚ÇÄ=${x.toFixed(4)}, p/va_p‚ÇÄ-p=${y.toFixed(4)}`;
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'p/p‚ÇÄ' },
          min: currentXmin !== null ? currentXmin : undefined,
          max: currentXmax !== null ? currentXmax : undefined,
          grid: { display: true, color: 'rgba(0,0,0,0.06)' }
        },
        y: {
          title: { display: true, text: 'p/va_p‚ÇÄ-p' },
          grid: { display: true, color: 'rgba(0,0,0,0.06)' }
        }
      }
    }
  });

  function applyRange() {
    const xminStr = document.getElementById('range_xmin').value;
    const xmaxStr = document.getElementById('range_xmax').value;

    currentXmin = xminStr !== '' ? Number(xminStr) : null;
    currentXmax = xmaxStr !== '' ? Number(xmaxStr) : null;

    const seg = splitCoreSegment(allPoints, currentXmin, currentXmax);
    betChart.data.datasets[0].data = seg.full;
    betChart.data.datasets[1].data = seg.core;

    betChart.options.scales.x.min =
      currentXmin !== null && !Number.isNaN(currentXmin) ? currentXmin : undefined;
    betChart.options.scales.x.max =
      currentXmax !== null && !Number.isNaN(currentXmax) ? currentXmax : undefined;

    betChart.update();
  }

</script>
</body>
</html>
